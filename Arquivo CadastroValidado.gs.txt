// Arquivo: CadastroValidado.gs
// Cont√©m as fun√ß√µes corrigidas para valida√ß√£o e prepara√ß√£o do cadastro com Supabase

// Configura√ß√µes centralizadas do Supabase (URL, chave, tabela)
const SUPABASE_CONFIG = {
  url: "https://bzornmxghivwmugqpwbo.supabase.co", // URL correta
  key: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ6b3JubXhnaGl2d211Z3Fwd2JvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA5NDU0MTMsImV4cCI6MjA2NjUyMTQxM30.Psh5J47Qpm1SjJr8giwiIwalPdmTq4mEFBp-83JCaC0", // Chave anon correta
  table: "validacao_fusma" // nome correto da tabela (min√∫sculo)
};

/**
 * Fun√ß√£o auxiliar para fazer requisi√ß√µes ao Supabase
 * @param {string} endpoint - Endpoint da API
 * @param {string} method - M√©todo HTTP (GET, POST, etc.)
 * @param {Object} payload - Dados para enviar (opcional)
 * @returns {Object} Resposta da API
 */
function supabaseRequest(endpoint, method = 'GET', payload = null) {
  try {
    const url = `${SUPABASE_CONFIG.url}/rest/v1/${endpoint}`;
    
    const options = {
      method: method,
      headers: {
        'apikey': SUPABASE_CONFIG.key,
        'Authorization': `Bearer ${SUPABASE_CONFIG.key}`,
        'Content-Type': 'application/json',
        'Prefer': 'return=representation'
      },
      muteHttpExceptions: true
    };

    if (payload && (method === 'POST' || method === 'PATCH')) {
      options.payload = JSON.stringify(payload);
    }

    console.log(`Fazendo requisi√ß√£o para: ${url}`);
    console.log(`M√©todo: ${method}`);
    if (payload) console.log(`Payload: ${JSON.stringify(payload)}`);

    const response = UrlFetchApp.fetch(url, options);
    const responseCode = response.getResponseCode();
    const responseText = response.getContentText();

    console.log(`C√≥digo de resposta: ${responseCode}`);
    console.log(`Resposta: ${responseText}`);

    if (responseCode >= 200 && responseCode < 300) {
      return {
        success: true,
        data: responseText ? JSON.parse(responseText) : null,
        code: responseCode
      };
    } else {
      return {
        success: false,
        error: responseText,
        code: responseCode
      };
    }
  } catch (error) {
    console.error('Erro na requisi√ß√£o Supabase:', error);
    return {
      success: false,
      error: error.toString(),
      code: 0
    };
  }
}

/**
 * Testa a conectividade com o Supabase
 * @returns {Object} Resultado do teste
 */
function testarConexaoSupabase() {
  try {
    console.log('Testando conex√£o com Supabase...');
    
    // Tenta fazer uma consulta simples para testar a conex√£o
    const response = supabaseRequest(`${SUPABASE_CONFIG.table}?select=count&limit=1`);
    
    if (response.success) {
      console.log('‚úÖ Conex√£o com Supabase estabelecida com sucesso!');
      return { status: 'ok', message: 'Conex√£o estabelecida com sucesso' };
    } else {
      console.log('‚ùå Erro na conex√£o com Supabase:', response.error);
      return { 
        status: 'erro', 
        message: `Erro de conex√£o: HTTP ${response.code} - ${response.error}` 
      };
    }
  } catch (error) {
    console.error('Erro ao testar conex√£o:', error);
    return { 
      status: 'erro', 
      message: `Erro interno: ${error.toString()}` 
    };
  }
}

/**
 * Verifica se o NIP e a data de nascimento est√£o autorizados na tabela ValidacaoFusma do Supabase
 * @param {string} nip - N√∫mero de identifica√ß√£o
 * @param {string} nascimento - Data de nascimento no formato YYYY-MM-DD
 * @returns {Object} Resultado da valida√ß√£o
 */
function verificarFusma(nip, nascimento) {
  try {
    console.log(`Verificando FUSMA - NIP: ${nip}, Nascimento: ${nascimento}`);
    
    const nipLimpo = String(nip).replace(/^\'/, '').trim();
    const nascimentoLimpo = String(nascimento).trim();

    // Primeiro testa a conex√£o
    const testeConexao = testarConexaoSupabase();
    if (testeConexao.status === 'erro') {
      return testeConexao;
    }

    // Tenta diferentes formatos de data
    const formatosData = [
      nascimentoLimpo, // Formato original
      nascimentoLimpo.replace(/\//g, '-'), // Troca / por -
      formatarDataPadrao(nascimentoLimpo) // Formato yyyy-mm-dd
    ];

    for (let formato of formatosData) {
      console.log(`Tentando formato de data: ${formato}`);
      
      const endpoint = `${SUPABASE_CONFIG.table}?NIP=eq.${encodeURIComponent(nipLimpo)}&DataNascimento=eq.${encodeURIComponent(formato)}&select=NIP,Nome,DataNascimento,Cidade`;
      const response = supabaseRequest(endpoint);

      if (response.success && response.data && response.data.length > 0) {
        const pessoa = response.data[0];
        console.log('‚úÖ Dados encontrados:', pessoa);
        return { 
          status: "ok", 
          nome: pessoa.Nome, 
          cidade: pessoa.Cidade || "",
          nip: pessoa.NIP,
          nascimento: pessoa.DataNascimento
        };
      }
    }

    // Se n√£o encontrou, tenta buscar apenas por NIP para debug
    console.log('Buscando apenas por NIP para debug...');
    const debugEndpoint = `${SUPABASE_CONFIG.table}?NIP=eq.${encodeURIComponent(nipLimpo)}&select=NIP,Nome,DataNascimento,Cidade`;
    const debugResponse = supabaseRequest(debugEndpoint);

    if (debugResponse.success && debugResponse.data && debugResponse.data.length > 0) {
      const pessoa = debugResponse.data[0];
      console.log('NIP encontrado, mas data n√£o confere:', pessoa);
      return { 
        status: "erro", 
        msg: `NIP encontrado, mas a data de nascimento n√£o confere. Data no sistema: ${pessoa.DataNascimento}` 
      };
    }

    console.log('NIP n√£o encontrado na base');
    return { 
      status: "erro", 
      msg: "NIP n√£o encontrado na base de dados." 
    };

  } catch (error) {
    console.error('Erro em verificarFusma:', error);
    return { 
      status: "erro", 
      msg: `Erro interno durante a valida√ß√£o: ${error.toString()}` 
    };
  }
}

/**
 * Formata data para o padr√£o yyyy-mm-dd
 * @param {string} data - Data em qualquer formato
 * @returns {string} Data formatada
 */
function formatarDataPadrao(data) {
  try {
    // Remove espa√ßos e caracteres especiais
    let dataLimpa = data.replace(/[^\d\/\-]/g, '');
    
    // Se j√° est√° no formato yyyy-mm-dd, retorna como est√°
    if (/^\d{4}-\d{2}-\d{2}$/.test(dataLimpa)) {
      return dataLimpa;
    }
    
    // Tenta converter diferentes formatos
    let partes;
    
    if (dataLimpa.includes('/')) {
      partes = dataLimpa.split('/');
    } else if (dataLimpa.includes('-')) {
      partes = dataLimpa.split('-');
    } else {
      return data; // Retorna original se n√£o conseguir processar
    }
    
    if (partes.length === 3) {
      // Se o primeiro elemento tem 4 d√≠gitos, assume yyyy-mm-dd ou yyyy/mm/dd
      if (partes[0].length === 4) {
        return `${partes[0]}-${partes[1].padStart(2, '0')}-${partes[2].padStart(2, '0')}`;
      }
      // Sen√£o, assume dd/mm/yyyy ou dd-mm-yyyy
      else {
        return `${partes[2]}-${partes[1].padStart(2, '0')}-${partes[0].padStart(2, '0')}`;
      }
    }
    
    return data; // Retorna original se n√£o conseguir processar
  } catch (error) {
    console.error('Erro ao formatar data:', error);
    return data;
  }
}

/**
 * Verifica se o NIP j√° est√° cadastrado na aba UsuariosCadastrados
 * @param {string} nip - N√∫mero de identifica√ß√£o
 * @returns {boolean} true se j√° existe, false caso contr√°rio
 */
function verificarCadastroExistente(nip) {
  try {
    const aba = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("UsuariosCadastrados");
    if (!aba) {
      console.error("Aba 'UsuariosCadastrados' n√£o encontrada");
      return false;
    }

    const ultimaLinha = aba.getLastRow();
    if (ultimaLinha <= 1) return false; // S√≥ tem cabe√ßalho

    const nips = aba.getRange(2, 1, ultimaLinha - 1, 1).getValues();
    const nipLimpo = String(nip).replace(/^'/, '').trim();

    for (let i = 0; i < nips.length; i++) {
      const nipAtual = String(nips[i][0] || "").replace(/^'/, '').trim();
      if (nipAtual === nipLimpo) {
        console.log(`NIP ${nipLimpo} j√° existe na linha ${i + 2}`);
        return true;
      }
    }
    
    console.log(`NIP ${nipLimpo} n√£o encontrado na planilha`);
    return false;
  } catch (error) {
    console.error('Erro ao verificar cadastro existente:', error);
    return false;
  }
}

/**
 * Retorna os dados do NIP validado diretamente do Supabase
 * @param {string} nip - N√∫mero de identifica√ß√£o
 * @returns {Object|null} Dados do usu√°rio ou null se n√£o encontrado
 */
function prepararDadosCadastro(nip) {
  try {
    console.log(`Preparando dados do cadastro para NIP: ${nip}`);
    
    const nipLimpo = String(nip).replace(/^\'/, '').trim();
    const endpoint = `${SUPABASE_CONFIG.table}?NIP=eq.${encodeURIComponent(nipLimpo)}&select=NIP,Nome,DataNascimento,Cidade`;
    
    const response = supabaseRequest(endpoint);
    
    if (response.success && response.data && response.data.length > 0) {
      const pessoa = response.data[0];
      
      return {
        nome: pessoa.Nome || "",
        nascimento: pessoa.DataNascimento || "",
        cidade: pessoa.Cidade || ""
      };
    }
    
    console.log('Dados n√£o encontrados para o NIP:', nipLimpo);
    return null;
    
  } catch (error) {
    console.error("Erro em prepararDadosCadastro:", error);
    return null;
  }
}

/**
 * Grava os dados finais do novo usu√°rio na aba UsuariosCadastrados
 * @param {string} nip - N√∫mero de identifica√ß√£o
 * @param {string} nome - Nome completo
 * @param {string} nascimento - Data de nascimento
 * @param {string} cidade - Cidade
 * @param {string} email - Email
 * @param {string} celular - Celular
 * @param {string} vinculo - V√≠nculo
 * @param {string} senha - Senha
 * @returns {Object} Resultado da opera√ß√£o
 */
function cadastrarUsuario(nip, nome, nascimento, cidade, email, celular, vinculo, senha) {
  try {
    console.log(`Cadastrando usu√°rio - NIP: ${nip}`);
    
    const aba = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("UsuariosCadastrados");
    if (!aba) {
      return { status: "erro", msg: "Erro interno: aba de cadastro n√£o encontrada." };
    }

    const nipLimpo = String(nip).replace(/^\'/, '').trim();
    
    // Verifica se NIP j√° est√° cadastrado
    if (verificarCadastroExistente(nipLimpo)) {
      return { status: "erro", msg: "Este NIP j√° possui cadastro no sistema." };
    }

    const nipTexto = `'${nipLimpo}`;
    const senhaHash = hashSenha(senha);
    const dataCadastro = new Date();

    // Adiciona os dados na planilha
    aba.appendRow([
      nipTexto,
      nome,
      nascimento,
      cidade,
      email,
      celular,
      vinculo,
      senhaHash,
      "Ativo",
      dataCadastro
    ]);

    console.log('‚úÖ Usu√°rio cadastrado com sucesso');
    return { status: "ok", msg: "Usu√°rio cadastrado com sucesso!" };
    
  } catch (error) {
    console.error('Erro ao cadastrar usu√°rio:', error);
    return { status: "erro", msg: "Erro interno ao finalizar o cadastro." };
  }
}

/**
 * Fun√ß√£o para hash da senha (implementa√ß√£o b√°sica)
 * RECOMENDA√á√ÉO: Use uma biblioteca de hash mais robusta em produ√ß√£o
 * @param {string} senha - Senha em texto plano
 * @returns {string} Hash da senha
 */
function hashSenha(senha) {
  try {
    // Implementa√ß√£o b√°sica usando Utilities.computeDigest
    const digest = Utilities.computeDigest(Utilities.DigestAlgorithm.SHA_256, senha);
    return digest.map(byte => (byte & 0xFF).toString(16).padStart(2, '0')).join('');
  } catch (error) {
    console.error('Erro ao fazer hash da senha:', error);
    // Fallback simples (N√ÉO recomendado para produ√ß√£o)
    return Utilities.base64Encode(senha);
  }
}

// ------------- Fun√ß√µes de Teste -------------

/**
 * Testa a fun√ß√£o verificarFusma
 */
function testarVerificarFusma() {
  console.log('=== Teste verificarFusma ===');
  
  // Teste com dados v√°lidos (SUBSTITUA por dados reais do seu Supabase)
  const nipTeste = "05018293"; 
  const dataTeste = "1985-02-07"; 
  
  console.log(`Testando com NIP: ${nipTeste}, Data: ${dataTeste}`);
  const resultado = verificarFusma(nipTeste, dataTeste);
  console.log("Resultado:", JSON.stringify(resultado, null, 2));
  
  // Teste com dados inv√°lidos
  console.log('\nTestando com dados inv√°lidos...');
  const resultadoErro = verificarFusma(nipTeste, "1985-02-17");
  console.log("Resultado (erro esperado):", JSON.stringify(resultadoErro, null, 2));
}

/**
 * Testa a fun√ß√£o prepararDadosCadastro
 */
function testarPrepararDadosCadastro() {
  console.log('=== Teste prepararDadosCadastro ===');
  
  const nipTeste = "05018293"; // Use um NIP v√°lido
  console.log(`Testando com NIP: ${nipTeste}`);
  
  const resultado = prepararDadosCadastro(nipTeste);
  console.log("Resultado:", JSON.stringify(resultado, null, 2));
}

/**
 * Testa a conectividade com Supabase
 */
function testarConexao() {
  console.log('=== Teste de Conex√£o ===');
  const resultado = testarConexaoSupabase();
  console.log("Resultado:", JSON.stringify(resultado, null, 2));
}

/**
 * Executa todos os testes
 */
function executarTodosOsTestes() {
  console.log('üöÄ Executando todos os testes...\n');
  
  testarConexao();
  console.log('\n' + '='.repeat(50) + '\n');
  
  testarVerificarFusma();
  console.log('\n' + '='.repeat(50) + '\n');
  
  testarPrepararDadosCadastro();
  console.log('\n' + '='.repeat(50) + '\n');
  
  console.log('‚úÖ Todos os testes conclu√≠dos! Verifique os logs para resultados.');
}
